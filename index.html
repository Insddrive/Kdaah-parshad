<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parshad Sewa">
    
    <title>Karah Parshad Calculator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --text-main: #ffffff;
            --text-muted: #888888;
            --orange: #FF8C00;
            --blue: #0052CC;
            --blue-active: #003d99;
            --green: #22c55e;
            --red: #ef4444;
            --border: #333333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
            /* ਇਹ ਲਾਈਨ ਐਂਡਰਾਇਡ ਦੇ ਆਪਣੇ ਰਿਫ੍ਰੈਸ਼ਰ ਨੂੰ ਰੋਕਦੀ ਹੈ */
            overscroll-behavior-y: none; 
            overscroll-behavior: none;
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Pull to Refresh Spinner */
        #ptr-container {
            position: fixed;
            top: -80px; /* ਥੋੜ੍ਹਾ ਹੋਰ ਉੱਪਰ ਲੁਕੋਇਆ */
            left: 0;
            width: 100%;
            height: 80px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            z-index: 9999;
            pointer-events: none;
            transition: top 0.1s ease-out;
        }
        .ptr-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top: 3px solid var(--orange);
            border-radius: 50%;
            transform: rotate(0deg);
        }
        .ptr-loading .ptr-spinner {
            animation: spin 0.7s linear infinite;
            border-color: #333;
            border-top-color: var(--green);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Typography */
        h1 { color: var(--orange); font-size: 1.2rem; font-weight: bold; text-align: center; }
        .header { padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; z-index: 10; background: var(--bg-color); }
        .sub-text { font-size: 0.8rem; color: var(--text-muted); }

        /* Inputs & Forms */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px; }
        
        label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
        
        input {
            width: 100%;
            background: var(--bg-color);
            border: 1px solid #ffffff;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            outline: none;
        }
        input:focus { border-color: var(--orange); box-shadow: 0 0 8px var(--orange); }
        input.green-text { color: var(--green); border-color: #555; }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-primary { background-color: var(--blue); color: white; border: 1px solid #3b82f6; margin-bottom: 10px; }
        .btn-primary:active { background-color: var(--blue-active); transform: scale(0.98); }
        
        .btn-reset { background-color: var(--card-bg); color: #ccc; border: 1px solid var(--border); }
        .btn-reset:active { background-color: #222; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 6px; background: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border); font-weight: bold; text-align: center; cursor: pointer; }
        .tab-btn.active { background: var(--orange); color: white; border-color: var(--orange); }

        /* Results */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; height: 100%; }
        
        .result-box { display: flex; gap: 10px; margin-bottom: 10px; }
        .box { flex: 1; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; }
        .box-green { border-color: #14532d; }
        .text-lg { font-size: 1.2rem; font-weight: bold; }
        .text-xl { font-size: 1.5rem; font-weight: bold; }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }

        /* List */
        .list-container { flex-grow: 1; overflow-y: auto; padding-bottom: 60px; -webkit-overflow-scrolling: touch; }
        .card {
            background: var(--bg-color);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-left { display: flex; align-items: center; gap: 10px; }
        .badge {
            width: 40px; height: 40px;
            border: 1px solid var(--orange);
            color: var(--orange);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.9rem;
        }

        /* Empty State */
        .empty-state { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.3; }
        .empty-icon { font-size: 3rem; margin-bottom: 10px; }

        /* Grid for Denominations */
        .deno-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .deno-btn {
            padding: 10px; background: var(--card-bg); border: 1px solid var(--border); color: #ccc;
            border-radius: 6px; font-weight: bold; cursor: pointer;
        }
        .deno-btn.selected { background: var(--blue); color: white; border-color: #3b82f6; }

        /* Footer Reset */
        .footer { position: fixed; bottom: 10px; left: 10px; right: 10px; }

        /* iOS Install Prompt Styling */
        #ios-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: #222;
            border: 1px solid var(--orange);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            color: white;
        }
        .ios-prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ios-prompt-close { background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer; }
        .ios-instructions { font-size: 0.9rem; line-height: 1.4; color: #ccc; }
        .ios-icon-plus { display: inline-block; vertical-align: middle; margin: 0 5px; background: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.8rem;}

    </style>
</head>
<body>

    <!-- Pull to Refresh Indicator -->
    <div id="ptr-container">
        <div id="ptr-spinner" class="ptr-spinner"></div>
    </div>

    <!-- iOS Install Prompt -->
    <div id="ios-install-prompt">
        <div class="ios-prompt-header">
            <span style="color: var(--orange); font-weight: bold;">ਆਈਫੋਨ 'ਤੇ ਇੰਸਟਾਲ ਕਰੋ</span>
            <button class="ios-prompt-close" onclick="closeIosPrompt()">×</button>
        </div>
        <div class="ios-instructions">
            1. ਹੇਠਾਂ ਦਿੱਤੇ <strong>Share</strong> <span style="font-size:1.2rem">⎋</span> ਬਟਨ 'ਤੇ ਕਲਿੱਕ ਕਰੋ।<br>
            2. ਫਿਰ <strong>'Add to Home Screen'</strong> <span class="ios-icon-plus">+</span> ਚੁਣੋ।
        </div>
    </div>

    <div class="header">
        <h1>ਸੱਚਖੰਡ ਸ੍ਰੀ ਹਰਿਮੰਦਰ ਸਾਹਿਬ</h1>
        <span class="sub-text">ਸੇਵਾ ਸਹਾਇਕ (Offline)</span>
    </div>

    <div class="tabs">
        <div id="tab-amount" class="tab-btn active" onclick="switchTab('amount')">ਰਕਮ (Amount)</div>
        <div id="tab-count" class="tab-btn" onclick="switchTab('count')">ਗਿਣਤੀ (Count)</div>
    </div>

    <!-- TAB 1: AMOUNT -->
    <div id="content-amount" class="flex-col">
        <div class="grid-2">
            <div>
                <label>ਪ੍ਰਸ਼ਾਦ ਦੀ ਰਕਮ</label>
                <input type="number" id="amount" placeholder="0" onkeypress="handleEnter(event, 'cashGiven')">
            </div>
            <div>
                <label>ਸੰਗਤ ਨੇ ਦਿੱਤੇ</label>
                <input type="number" id="cashGiven" class="green-text" placeholder="0" onkeypress="handleEnter(event, 'calculate')">
            </div>
        </div>

        <button class="btn btn-primary" onclick="calculateSlips()">ਹਿਸਾਬ ਲਗਾਓ (Enter)</button>

        <div id="result-container" class="hidden flex-col">
            <div class="result-box">
                <div class="box">
                    <label>ਕੁੱਲ ਰਕਮ</label>
                    <div id="display-total" class="text-lg">Rs. 0</div>
                </div>
                <div class="box box-green">
                    <label class="text-green">ਵਾਪਸ (Balance)</label>
                    <div id="display-balance" class="text-xl text-green">Rs. 0</div>
                </div>
            </div>
            <div id="slips-list" class="list-container"></div>
        </div>

        <div id="empty-state" class="empty-state">
            <div class="empty-icon">☬</div>
            <p>ਰਕਮ ਭਰੋ</p>
        </div>

        <div class="footer" id="reset-btn-amount">
            <button class="btn btn-reset" onclick="resetForm()">ਸਾਫ਼ ਕਰੋ (Clear)</button>
        </div>
    </div>

    <!-- TAB 2: COUNT -->
    <div id="content-count" class="hidden flex-col">
        <label style="margin-left: 2px;">ਪਰਚੀ ਚੁਣੋ:</label>
        <div id="deno-grid" class="deno-grid"></div>

        <div class="grid-3">
            <div>
                <label>ਗਿਣਤੀ</label>
                <input type="number" id="count-input" value="1" oninput="calculateManualTotal()">
            </div>
            <div>
                <label>ਸੰਗਤ ਨੇ ਦਿੱਤੇ</label>
                <input type="number" id="manual-cash-given" class="green-text" placeholder="0" oninput="calculateManualTotal()">
            </div>
        </div>

        <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <span class="sub-text">ਬਟਨ:</span>
                <span id="manual-key-display" style="color: var(--orange); font-weight: bold; font-size: 1.2rem;">-</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="color: #ccc;">ਕੁੱਲ ਰਕਮ:</span>
                <span id="manual-total-display" style="font-size: 1.8rem; font-weight: bold;">Rs. 0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: black; padding: 10px; border-radius: 4px; border: 1px solid #14532d;">
                <span class="text-green">ਵਾਪਸ ਕਰਨੇ:</span>
                <span id="manual-balance-display" style="font-size: 1.5rem; font-weight: bold; color: var(--green);">-</span>
            </div>
        </div>

        <div class="footer">
            <button class="btn btn-reset" onclick="resetManual()">ਨਵਾਂ ਹਿਸਾਬ (Reset)</button>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Failed', err));
        }

        // --- Universal Pull to Refresh (Android & iOS) ---
        const ptrContainer = document.getElementById('ptr-container');
        const ptrSpinner = document.getElementById('ptr-spinner');
        let ptrStartY = 0;
        let ptrIsPulling = false;

        // Check if user is at the top of the scrollable area
        function isScrollAtTop() {
            const list = document.getElementById('slips-list');
            const isAmountTab = !document.getElementById('content-amount').classList.contains('hidden');
            
            // If in Amount tab and list exists, check its scroll position
            if (isAmountTab && list) {
                return list.scrollTop <= 0;
            }
            // If in Amount tab but list is empty, or in Count tab, we are effectively at top
            return true;
        }

        // 1. TOUCH START
        document.addEventListener('touchstart', (e) => {
            // We only care if we are at the top
            if (isScrollAtTop()) {
                ptrStartY = e.touches[0].clientY;
                ptrIsPulling = false;
            }
        }, { passive: true });

        // 2. TOUCH MOVE (The most important part)
        document.addEventListener('touchmove', (e) => {
            const currentY = e.touches[0].clientY;
            const diff = currentY - ptrStartY;
            
            // Only engage if:
            // 1. User is pulling DOWN (diff > 0)
            // 2. We are at the top of the page (isScrollAtTop)
            // 3. User isn't just tapping, but dragging (> 5px)
            if (diff > 0 && isScrollAtTop()) {
                 
                 // Prevent default behavior (Stops Android Refresh & iOS Bounce)
                 // This requires { passive: false } in the event listener options
                 if (e.cancelable && diff > 5) {
                     e.preventDefault();
                     ptrIsPulling = true;
                 }

                 if (ptrIsPulling) {
                     // Add resistance to the pull (0.4 factor)
                     const move = Math.min(diff * 0.4, 110); 
                     ptrContainer.style.top = (move - 80) + 'px';
                     ptrSpinner.style.transform = `rotate(${move * 3}deg)`;
                 }
            } else {
                // If user scrolls back up, reset
                ptrIsPulling = false;
                ptrContainer.style.top = '-80px';
            }
        }, { passive: false }); // <--- CRITICAL for both Android and iOS support

        // 3. TOUCH END
        document.addEventListener('touchend', (e) => {
            if (!ptrIsPulling) return;
            ptrIsPulling = false;

            const currentY = e.changedTouches[0].clientY;
            const diff = currentY - ptrStartY;

            // If pulled enough (threshold 150px)
            if (diff > 150) { 
                // Show loading state
                ptrContainer.style.top = '15px';
                ptrContainer.classList.add('ptr-loading');
                
                // Haptic Feedback (Works on Android)
                if (navigator.vibrate) navigator.vibrate(50);

                // Reload page
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                // Snap back to hidden
                ptrContainer.style.top = '-80px';
            }
        });
        // --------------------------------------------------

        // --- iOS Detection & Prompt Logic ---
        function isIos() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }
        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }

        window.onload = function() {
            renderDenominationGrid();
            if (isIos() && !isInStandaloneMode()) {
                if (!sessionStorage.getItem('iosPromptClosed')) {
                    document.getElementById('ios-install-prompt').style.display = 'block';
                }
            }
        }

        function closeIosPrompt() {
            document.getElementById('ios-install-prompt').style.display = 'none';
            sessionStorage.setItem('iosPromptClosed', 'true');
        }
        
        // --- Calculator Logic ---
        const SLIPS = [
            { value: 10, key: "F2" }, { value: 11, key: "F3" },
            { value: 20, key: "F4" }, { value: 21, key: "F5" },
            { value: 50, key: "F6" }, { value: 51, key: "F7" },
            { value: 100, key: "F8" }, { value: 101, key: "F9" },
            { value: 500, key: "SHIFT + F10" }, { value: 501, key: "SHIFT + F11" },
            { value: 1000, key: "SHIFT + F12" }
        ];

        let selectedDenomination = null;

        function switchTab(tab) {
            document.getElementById('content-amount').classList.toggle('hidden', tab !== 'amount');
            document.getElementById('content-count').classList.toggle('hidden', tab !== 'count');
            
            document.getElementById('tab-amount').classList.toggle('active', tab === 'amount');
            document.getElementById('tab-count').classList.toggle('active', tab === 'count');

            if(tab === 'amount') document.getElementById('amount').focus();
        }

        function renderDenominationGrid() {
            const grid = document.getElementById('deno-grid');
            grid.innerHTML = '';
            SLIPS.forEach(slip => {
                const btn = document.createElement('div');
                btn.innerText = slip.value;
                btn.className = 'deno-btn';
                btn.onclick = () => {
                    document.querySelectorAll('.deno-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedDenomination = slip;
                    document.getElementById('manual-key-display').innerText = slip.key;
                    document.getElementById('count-input').focus();
                    document.getElementById('count-input').select();
                    calculateManualTotal();
                };
                grid.appendChild(btn);
            });
        }

        function calculateManualTotal() {
            if (!selectedDenomination) return;
            const count = parseInt(document.getElementById('count-input').value) || 0;
            const cashGiven = parseInt(document.getElementById('manual-cash-given').value) || 0;
            const total = selectedDenomination.value * count;
            
            document.getElementById('manual-total-display').innerText = `Rs. ${total}`;
            
            const balDisplay = document.getElementById('manual-balance-display');
            if (cashGiven > 0) {
                const bal = cashGiven - total;
                balDisplay.innerText = bal < 0 ? `ਘੱਟ: ${Math.abs(bal)}` : `Rs. ${bal}`;
                balDisplay.style.color = bal < 0 ? 'var(--red)' : 'var(--green)';
            } else {
                balDisplay.innerText = "-";
                balDisplay.style.color = 'var(--green)';
            }
        }

        function resetManual() {
            selectedDenomination = null;
            document.querySelectorAll('.deno-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('count-input').value = 1;
            document.getElementById('manual-cash-given').value = '';
            document.getElementById('manual-total-display').innerText = 'Rs. 0';
            document.getElementById('manual-balance-display').innerText = '-';
            document.getElementById('manual-key-display').innerText = '-';
        }

        function handleEnter(e, next) {
            if (e.key === 'Enter') {
                if (next === 'cashGiven') document.getElementById('cashGiven').focus();
                else calculateSlips();
            }
        }

        function calculateSlips() {
            const amount = parseInt(document.getElementById('amount').value);
            if (!amount || amount < 10) return;

            const cashGiven = parseInt(document.getElementById('cashGiven').value) || 0;
            const balance = cashGiven - amount;

            document.getElementById('display-total').innerText = `Rs. ${amount}`;
            const balDisplay = document.getElementById('display-balance');
            
            if (cashGiven > 0) {
                balDisplay.innerText = balance < 0 ? `ਘੱਟ: ${Math.abs(balance)}` : `Rs. ${balance}`;
                balDisplay.style.color = balance < 0 ? 'var(--red)' : 'var(--green)';
            } else {
                balDisplay.innerText = "-";
                balDisplay.style.color = 'var(--text-muted)';
            }

            // DP Algorithm
            let calcAmount = amount;
            let thousands = 0;
            if(calcAmount > 5000) {
                thousands = Math.floor((calcAmount - 5000)/1000);
                calcAmount -= thousands * 1000;
            }

            const dpSlips = [...SLIPS].sort((a,b) => b.value - a.value);
            const dp = new Array(calcAmount + 1).fill(Infinity);
            const parent = new Array(calcAmount + 1).fill(0);
            dp[0] = 0;

            for (let i = 1; i <= calcAmount; i++) {
                for (let slip of dpSlips) {
                    if (i >= slip.value && dp[i - slip.value] + 1 < dp[i]) {
                        dp[i] = dp[i - slip.value] + 1;
                        parent[i] = slip.value;
                    }
                }
            }

            if (dp[calcAmount] === Infinity) {
                alert("ਹਿਸਾਬ ਸੰਭਵ ਨਹੀਂ"); return;
            }

            const result = [];
            for(let i=0; i<thousands; i++) result.push(1000);
            while (calcAmount > 0) {
                result.push(parent[calcAmount]);
                calcAmount -= parent[calcAmount];
            }

            // Render
            const list = document.getElementById('slips-list');
            list.innerHTML = '';
            
            const counts = {};
            result.forEach(v => counts[v] = (counts[v] || 0) + 1);
            
            Object.keys(counts).sort((a,b) => b-a).forEach(val => {
                const slip = SLIPS.find(s => s.value == val);
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-left">
                        <div class="badge">${val}</div>
                        <div class="text-lg">${slip.key}</div>
                    </div>
                    <div class="text-xl" style="color: var(--orange)">x ${counts[val]}</div>
                `;
                list.appendChild(div);
            });

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-container').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('amount').value = '';
            document.getElementById('cashGiven').value = '';
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('amount').focus();
        }
    </script>
</body>
</html>


